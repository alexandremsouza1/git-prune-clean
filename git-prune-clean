#!/bin/bash

# Verifica se estÃ¡ em um repositÃ³rio Git
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
  echo "âŒ VocÃª nÃ£o estÃ¡ dentro de um repositÃ³rio Git."
  exit 1
fi

# Verifica se a branch develop existe
if ! git show-ref --verify --quiet refs/heads/develop; then
  echo "âŒ A branch 'develop' nÃ£o foi encontrada localmente."
  echo "ğŸ’¡ Execute: git checkout develop && git pull origin develop"
  exit 1
fi

echo "ğŸ”„ Atualizando referÃªncias remotas..."
git fetch --prune

echo "ğŸ” Analisando branches locais..."

# Pega a branch atual para evitar deletÃ¡-la
current_branch=$(git branch --show-current)

# Lista todas as branches locais (exceto develop e a atual)
local_branches=$(git branch | grep -v "^\*" | grep -v "develop" | sed 's/^ *//')

# Arrays para armazenar diferentes tipos de branches
merged_branches=()
orphan_branches=()
unmerged_branches=()

# Analisa cada branch local
for branch in $local_branches; do
  # Pula a branch atual
  if [ "$branch" = "$current_branch" ]; then
    continue
  fi
  
  # Verifica se a branch foi mergeada com develop
  if git merge-base --is-ancestor "$branch" develop 2>/dev/null; then
    # Verifica se ainda existe no remoto
    if git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
      # Existe no remoto mas jÃ¡ foi mergeada
      merged_branches+=("$branch")
    else
      # NÃ£o existe no remoto e jÃ¡ foi mergeada (Ã³rfÃ£)
      orphan_branches+=("$branch")
    fi
  else
    # NÃ£o foi mergeada com develop
    if ! git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
      # NÃ£o existe no remoto e nÃ£o foi mergeada
      unmerged_branches+=("$branch")
    fi
  fi
done

# Mostra resultados
echo ""
echo "ğŸ“Š AnÃ¡lise das branches locais:"
echo "==============================================="

if [ ${#merged_branches[@]} -gt 0 ]; then
  echo "âœ… Branches mergeadas com develop (seguras para deletar):"
  printf "   %s\n" "${merged_branches[@]}"
  echo ""
fi

if [ ${#orphan_branches[@]} -gt 0 ]; then
  echo "ğŸ”¶ Branches Ã³rfÃ£s mergeadas com develop (seguras para deletar):"
  printf "   %s\n" "${orphan_branches[@]}"
  echo ""
fi

if [ ${#unmerged_branches[@]} -gt 0 ]; then
  echo "âš ï¸  Branches Ã³rfÃ£s NÃƒO mergeadas (requerem atenÃ§Ã£o):"
  printf "   %s\n" "${unmerged_branches[@]}"
  echo "   â˜ï¸  Essas branches nÃ£o foram mergeadas e nÃ£o existem no remoto!"
  echo ""
fi

# Combina branches seguras para deletar
all_safe_branches=("${merged_branches[@]}" "${orphan_branches[@]}")

if [ ${#all_safe_branches[@]} -eq 0 ]; then
  echo "âœ… Nenhuma branch segura encontrada para deletar."
  exit 0
fi

# Pergunta sobre deleÃ§Ã£o das branches seguras
echo "â“ Deseja deletar as branches mergeadas com develop? (y/n): "
read -r answer

if [[ "$answer" =~ ^[Yy]$ ]]; then
  echo ""
  echo "ğŸ—‘ï¸  Deletando branches..."
  for branch in "${all_safe_branches[@]}"; do
    if git branch -d "$branch" 2>/dev/null; then
      echo "âœ… Deletada: $branch"
    else
      echo "âŒ Erro ao deletar: $branch"
    fi
  done
  echo ""
  echo "âœ… Processo concluÃ­do!"
else
  echo "âŒ Nenhuma branch foi deletada."
fi

# Se houver branches nÃ£o mergeadas, pergunta o que fazer
if [ ${#unmerged_branches[@]} -gt 0 ]; then
  echo ""
  echo "â“ Deseja forÃ§ar a deleÃ§Ã£o das branches NÃƒO mergeadas? (y/n): "
  echo "âš ï¸  ATENÃ‡ÃƒO: Isso pode causar perda de cÃ³digo!"
  read -r force_answer
  
  if [[ "$force_answer" =~ ^[Yy]$ ]]; then
    echo ""
    echo "ğŸ”¥ ForÃ§ando deleÃ§Ã£o de branches nÃ£o mergeadas..."
    for branch in "${unmerged_branches[@]}"; do
      if git branch -D "$branch" 2>/dev/null; then
        echo "ğŸ”¥ Deletada (forÃ§ado): $branch"
      else
        echo "âŒ Erro ao deletar: $branch"
      fi
    done
  else
    echo "âœ… Branches nÃ£o mergeadas foram preservadas."
  fi
fi
